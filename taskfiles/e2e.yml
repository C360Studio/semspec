version: "3"

tasks:
  # ============================================================================
  # Internal Build Tasks (not shown in --list)
  # ============================================================================

  build:
    internal: true
    desc: Build e2e test runner and semspec binary
    cmds:
      - echo "[BUILD] Building semspec binary..."
      - go build -o bin/semspec ./cmd/semspec
      - echo "[BUILD] Building e2e test runner..."
      - go build -o bin/e2e ./cmd/e2e
      - echo "[OK] Build complete"

  build-image:
    internal: true
    desc: Build semspec Docker image for E2E tests
    cmds:
      - echo "[BUILD-IMAGE] Building semspec Docker image..."
      - docker compose -f docker/compose/e2e.yml build semspec
      - echo "[OK] Docker image built"

  check-ports:
    internal: true
    desc: Check if required E2E ports are available
    silent: false
    cmds:
      - |
        echo "[CHECK] Verifying semspec E2E ports are available..."
        for port in 4322 8322 8180; do
          if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
            echo "[ERROR] Port $port is already in use:"
            lsof -Pi :$port -sTCP:LISTEN
            exit 1
          fi
        done
        echo "[OK] All semspec E2E ports available"

  clean:
    internal: true
    desc: Clean E2E Docker environment
    silent: false
    cmds:
      - echo "[CLEAN] Cleaning Semspec E2E Docker environment..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker rm -f nats-semspec 2>/dev/null || true
      - docker volume ls -q --filter name=semspec | xargs -r docker volume rm 2>/dev/null || true
      - docker network ls -q --filter name=semspec-e2e | xargs -r docker network rm 2>/dev/null || true
      - echo "[OK] Docker environment cleaned"

  clean-workspace:
    internal: true
    desc: Clean E2E workspace
    silent: false
    cmds:
      - echo "[CLEAN-WORKSPACE] Cleaning test workspace..."
      - docker run --rm -v $(pwd)/test/e2e/workspace:/workspace alpine sh -c "rm -rf /workspace/* /workspace/.semspec 2>/dev/null; ls -la /workspace/" || true
      - echo "[OK] Workspace cleaned"

  cleanup:
    internal: true
    desc: Post-test cleanup (called by defer)
    cmds:
      - echo "[E2E CLEANUP] Stopping infrastructure..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - echo "[OK] Cleanup complete"

  cleanup-llm:
    internal: true
    desc: Post-test cleanup for LLM E2E tests (called by defer)
    cmds:
      - echo "[E2E CLEANUP] Stopping LLM infrastructure..."
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-llm.yml down -v --timeout 15 2>/dev/null || true
      - echo "[OK] Cleanup complete"

  build-mock-image:
    internal: true
    desc: Build mock-llm Docker image for E2E tests
    cmds:
      - echo "[BUILD-IMAGE] Building mock-llm Docker image..."
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml build mock-llm
      - echo "[OK] Mock LLM image built"

  cleanup-mock:
    internal: true
    desc: Post-test cleanup for mock E2E tests (called by defer)
    cmds:
      - echo "[E2E CLEANUP] Stopping mock infrastructure..."
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml down -v --timeout 15 2>/dev/null || true
      - echo "[OK] Cleanup complete"

  cleanup-mock-pressure:
    internal: true
    desc: Post-test cleanup for mock pressure E2E tests (called by defer)
    cmds:
      - echo "[E2E CLEANUP] Stopping mock pressure infrastructure..."
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml -f docker/compose/e2e-mock-pressure.yml down -v --timeout 15 2>/dev/null || true
      - echo "[OK] Cleanup complete"

  cleanup-all-llm:
    internal: true
    desc: Post-test cleanup for any LLM E2E tests (handles both llm and mock overlays)
    cmds:
      - echo "[E2E CLEANUP] Stopping infrastructure..."
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-llm.yml down -v --timeout 15 2>/dev/null || true
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml down -v --timeout 15 2>/dev/null || true
      - echo "[OK] Cleanup complete"

  # ============================================================================
  # Infrastructure Tasks
  # ============================================================================

  up:
    desc: Start e2e infrastructure (NATS + semspec)
    deps: [build-image]
    cmds:
      - echo "[E2E UP] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - docker compose -f docker/compose/e2e.yml ps
      - echo "[OK] Infrastructure ready"

  down:
    desc: Stop e2e infrastructure and remove volumes
    cmds:
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15

  down:keep:
    desc: Stop e2e infrastructure but preserve volumes
    cmds:
      - echo "[DOWN:KEEP] Stopping infrastructure (volumes preserved)..."
      - docker compose -f docker/compose/e2e.yml down --timeout 15
      - echo "[DOWN:KEEP] Use 'task e2e:down' to remove volumes."

  logs:
    desc: Show logs from e2e services
    cmds:
      - docker compose -f docker/compose/e2e.yml logs -f

  watch:
    desc: Stream errors and warnings from semspec container
    cmds:
      - echo "[WATCH] Streaming ERROR/WARN logs (Ctrl+C to stop)..."
      - docker logs -f compose-semspec-1 2>&1 | grep -E "(ERROR|WARN|error|warn|panic|fatal)" --line-buffered

  status:
    desc: Check status of e2e infrastructure
    cmds:
      - echo "[STATUS] Docker containers:"
      - docker compose -f docker/compose/e2e.yml ps
      - echo ""
      - echo "[STATUS] NATS health (port 8322):"
      - curl -s http://localhost:8322/healthz || echo "  NATS not available"
      - echo ""
      - echo "[STATUS] Semspec HTTP health (port 8180):"
      - curl -s http://localhost:8180/readyz || echo "  Semspec not available"

  # ============================================================================
  # Test Execution Tasks
  # ============================================================================

  default:
    desc: Run all e2e tests (full lifecycle)
    deps: [clean, clean-workspace, check-ports, build, build-image]
    cmds:
      - echo "[E2E] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E] Running tests..."
      - cmd: ./bin/e2e --json --workspace $(pwd)/test/e2e/workspace all
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E] Tests complete"

  run:
    desc: "Run e2e scenario(s) - usage: task e2e:run -- <scenario>"
    deps: [build]
    cmds:
      - ./bin/e2e --workspace $(pwd)/test/e2e/workspace {{.CLI_ARGS | default "all"}}

  run-watch:
    desc: "Run scenario with error streaming - usage: task e2e:run-watch -- <scenario>"
    deps: [build]
    vars:
      SCENARIO:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $1}' | grep . || echo 'all'
    cmds:
      - |
        echo "[RUN-WATCH] Starting log stream + {{.SCENARIO}}..."
        docker logs -f compose-semspec-1 2>&1 | grep -E "(ERROR|WARN|error|warn|panic|fatal)" --line-buffered &
        LOG_PID=$!
        trap "kill $LOG_PID 2>/dev/null" EXIT

        ./bin/e2e --workspace $(pwd)/test/e2e/workspace {{.SCENARIO}}

  debug:
    desc: Start infrastructure for interactive debugging
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[DEBUG] Starting infrastructure for debugging..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - docker compose -f docker/compose/e2e.yml ps
      - echo ""
      - echo "[DEBUG] Useful commands:"
      - echo "  docker logs -f compose-semspec-1"
      - echo "  task e2e:run -- plan-workflow"
      - echo "  task e2e:down"
      - echo ""
      - docker logs -f compose-semspec-1 &
      - echo "[DEBUG] Press Ctrl+C to stop watching logs"
      - sleep infinity

  # Mock infrastructure management (for debugging)
  up:mock:
    desc: "Start mock infrastructure - usage: task e2e:up:mock -- <scenario>"
    deps: [clean, check-ports, build, build-image, build-mock-image]
    vars:
      SCENARIO:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $1}' | grep . || echo 'hello-world'
    cmds:
      - |
        echo "[UP:MOCK] Starting mock infrastructure for {{.SCENARIO}}..."
        MOCK_SCENARIO={{.SCENARIO}} docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml up -d --wait
        docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml ps
        echo ""
        echo "[OK] Mock infrastructure ready for scenario: {{.SCENARIO}}"
        echo ""
        echo "Run tests with:  task e2e:mock:run -- {{.SCENARIO}}"
        echo "View logs with:  task e2e:logs:mock"
        echo "Stop with:       task e2e:down:mock"

  down:mock:
    desc: Stop mock infrastructure
    cmds:
      - echo "[DOWN:MOCK] Stopping mock infrastructure..."
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml down -v --timeout 15
      - echo "[OK] Mock infrastructure stopped"

  logs:mock:
    desc: Show logs from mock e2e services (semspec + mock-llm)
    cmds:
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml logs -f

  status:mock:
    desc: Check status of mock e2e infrastructure
    cmds:
      - echo "[STATUS:MOCK] Docker containers:"
      - docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml ps
      - echo ""
      - echo "[STATUS:MOCK] NATS health (port 8322):"
      - curl -s http://localhost:8322/healthz || echo "  NATS not available"
      - echo ""
      - echo "[STATUS:MOCK] Semspec HTTP health (port 8180):"
      - curl -s http://localhost:8180/readyz || echo "  Semspec not available"
      - echo ""
      - echo "[STATUS:MOCK] Mock LLM health (port 11434):"
      - curl -s http://localhost:11434/health || echo "  Mock LLM not available"

  mock:run:
    desc: "Run scenario against running mock infrastructure - usage: task e2e:mock:run -- <scenario>"
    deps: [build]
    vars:
      SCENARIO:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $1}' | grep . || echo 'hello-world'
    cmds:
      - |
        echo "[MOCK:RUN] Running {{.SCENARIO}} against existing mock infrastructure..."
        E2E_PROVIDER_NAME=mock ./bin/e2e --json --fast-timeouts --mock-llm http://localhost:11434 --workspace $(pwd)/test/e2e/workspace {{.SCENARIO}}

  debug:mock:
    desc: "Start mock infrastructure and tail logs - usage: task e2e:debug:mock -- <scenario>"
    deps: [clean, check-ports, build, build-image, build-mock-image]
    vars:
      SCENARIO:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $1}' | grep . || echo 'hello-world'
    cmds:
      - |
        echo "[DEBUG:MOCK] Starting mock infrastructure for {{.SCENARIO}}..."
        MOCK_SCENARIO={{.SCENARIO}} docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml up -d --wait
        docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml ps
        echo ""
        echo "[DEBUG:MOCK] Useful commands:"
        echo "  task e2e:mock:run -- {{.SCENARIO}}"
        echo "  task e2e:status:mock"
        echo "  task e2e:down:mock"
        echo ""
        echo "[DEBUG:MOCK] Tailing semspec logs (Ctrl+C to stop)..."
      - docker logs -f compose-semspec-1

  nuke:
    desc: Nuclear cleanup - remove ALL semspec docker resources
    cmds:
      - echo "[NUKE] Removing ALL Semspec Docker resources..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker ps -a --filter name=semspec --format "{{.ID}}" | xargs -r docker rm -f 2>/dev/null || true
      - docker volume ls -q --filter name=semspec | xargs -r docker volume rm 2>/dev/null || true
      - docker network ls -q --filter name=semspec | xargs -r docker network rm 2>/dev/null || true
      - docker images --filter reference='*semspec*' --format "{{.ID}}" | xargs -r docker rmi -f 2>/dev/null || true
      - echo "[OK] Nuclear cleanup complete"

  # ============================================================================
  # LLM E2E Tests (requires LLM provider)
  # ============================================================================

  llm:
    desc: "Run LLM scenario - usage: task e2e:llm -- <scenario> [provider]"
    deps: [clean, clean-workspace, check-ports, build, build-image]
    vars:
      SCENARIO:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $1}' | grep . || echo 'hello-world'
      PROVIDER:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $2}' | grep . || echo 'local'
    cmds:
      - |
        echo "[E2E:LLM] Scenario: {{.SCENARIO}}, Provider: {{.PROVIDER}}"
        CONFIG_FILE="e2e-{{.PROVIDER}}.json"
        if [ ! -f "configs/${CONFIG_FILE}" ]; then
          echo "[ERROR] Config not found: configs/${CONFIG_FILE}"
          echo "Available providers: local, claude, openrouter, gemini, mock"
          echo "Available scenarios: hello-world, todo-app"
          exit 1
        fi
      - |
        # Mock provider uses its own compose overlay and Docker image
        if [ "{{.PROVIDER}}" = "mock" ]; then
          echo "[E2E:LLM] Building mock-llm image..."
          docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml build mock-llm
          echo "[E2E:LLM] Starting mock infrastructure..."
          docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml up -d --wait
        else
          if [ "{{.PROVIDER}}" = "gemini" ] && [ -n "${GEMINI_API_KEY:-}" ]; then
            export OPENAI_API_KEY="$GEMINI_API_KEY"
          fi
          echo "[E2E:LLM] Starting infrastructure..."
          E2E_CONFIG=e2e-{{.PROVIDER}}.json docker compose --env-file .env -f docker/compose/e2e.yml -f docker/compose/e2e-llm.yml up -d --wait
        fi
      - |
        if [ "{{.PROVIDER}}" = "gemini" ] && [ -n "${GEMINI_API_KEY:-}" ]; then
          export OPENAI_API_KEY="$GEMINI_API_KEY"
        fi
        echo "[E2E:LLM] Running {{.SCENARIO}} with {{.PROVIDER}}..."
        MOCK_LLM_FLAG=""
        if [ "{{.PROVIDER}}" = "mock" ]; then
          MOCK_LLM_FLAG="--mock-llm http://localhost:11434 --fast-timeouts"
        fi
        E2E_PROVIDER_NAME={{.PROVIDER}} ./bin/e2e --json $MOCK_LLM_FLAG --workspace $(pwd)/test/e2e/workspace {{.SCENARIO}}
      - defer: { task: cleanup-all-llm }
      - echo "[E2E:LLM] Complete"

  mock:
    desc: "Run mock LLM scenario - usage: task e2e:mock -- <scenario>"
    deps: [clean, clean-workspace, check-ports, build, build-image, build-mock-image]
    vars:
      SCENARIO:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $1}' | grep . || echo 'hello-world'
    cmds:
      - |
        echo "[E2E:MOCK] Scenario: {{.SCENARIO}}"
        echo "[E2E:MOCK] Starting infrastructure with mock LLM..."
        MOCK_SCENARIO={{.SCENARIO}} docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml up -d --wait
      - |
        echo "[E2E:MOCK] Running {{.SCENARIO}} with mock LLM..."
        E2E_PROVIDER_NAME=mock ./bin/e2e --json --fast-timeouts --mock-llm http://localhost:11434 --workspace $(pwd)/test/e2e/workspace {{.SCENARIO}}
      - defer: { task: cleanup-mock }
      - echo "[E2E:MOCK] Complete"

  mock-pressure:
    desc: "Run mock LLM pressure scenario - usage: task e2e:mock-pressure -- <scenario>"
    deps: [clean, clean-workspace, check-ports, build, build-image, build-mock-image]
    vars:
      SCENARIO:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $1}' | grep . || echo 'context-pressure'
    cmds:
      - |
        echo "[E2E:MOCK-PRESSURE] Scenario: {{.SCENARIO}}"
        echo "[E2E:MOCK-PRESSURE] Starting infrastructure with reduced token budget (8192)..."
        MOCK_SCENARIO={{.SCENARIO}} docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-mock.yml -f docker/compose/e2e-mock-pressure.yml up -d --wait
      - |
        echo "[E2E:MOCK-PRESSURE] Running {{.SCENARIO}} with mock LLM (pressure config)..."
        E2E_PROVIDER_NAME=mock ./bin/e2e --json --fast-timeouts --mock-llm http://localhost:11434 --workspace $(pwd)/test/e2e/workspace {{.SCENARIO}}
      - defer: { task: cleanup-mock-pressure }
      - echo "[E2E:MOCK-PRESSURE] Complete"

  llm-watch:
    desc: "Run LLM scenario with error streaming - usage: task e2e:llm-watch -- <scenario> [provider]"
    deps: [clean, clean-workspace, check-ports, build, build-image]
    vars:
      SCENARIO:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $1}' | grep . || echo 'hello-world'
      PROVIDER:
        sh: echo '{{.CLI_ARGS}}' | awk '{print $2}' | grep . || echo 'local'
    cmds:
      - |
        echo "[E2E:LLM-WATCH] Scenario: {{.SCENARIO}}, Provider: {{.PROVIDER}}"
        CONFIG_FILE="e2e-{{.PROVIDER}}.json"
        if [ ! -f "configs/${CONFIG_FILE}" ]; then
          echo "[ERROR] Config not found: configs/${CONFIG_FILE}"
          exit 1
        fi
      - |
        if [ "{{.PROVIDER}}" = "gemini" ] && [ -n "${GEMINI_API_KEY:-}" ]; then
          export OPENAI_API_KEY="$GEMINI_API_KEY"
        fi
        echo "[E2E:LLM-WATCH] Starting infrastructure..."
        E2E_CONFIG=e2e-{{.PROVIDER}}.json docker compose -f docker/compose/e2e.yml -f docker/compose/e2e-llm.yml up -d --wait
      - |
        echo "[E2E:LLM-WATCH] Starting log stream + test..."
        docker logs -f compose-semspec-1 2>&1 | grep -E "(ERROR|WARN|error|warn|panic|fatal)" --line-buffered &
        LOG_PID=$!
        trap "kill $LOG_PID 2>/dev/null" EXIT

        if [ "{{.PROVIDER}}" = "gemini" ] && [ -n "${GEMINI_API_KEY:-}" ]; then
          export OPENAI_API_KEY="$GEMINI_API_KEY"
        fi
        E2E_PROVIDER_NAME={{.PROVIDER}} ./bin/e2e --json --workspace $(pwd)/test/e2e/workspace {{.SCENARIO}}
      - defer: { task: cleanup-llm }
      - echo "[E2E:LLM-WATCH] Complete"

  # ============================================================================
  # UI E2E Testing Tasks
  # ============================================================================

  ui:
    desc: Run UI E2E tests with Playwright
    dir: ui
    cmds:
      - echo "[UI] Running Playwright tests..."
      - npx playwright test {{.CLI_ARGS}}
      - echo "[OK] UI E2E tests complete"

  ui:up:
    desc: Start UI E2E Docker stack
    dir: ui
    cmds:
      - echo "[UI:UP] Cleaning stale state..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15 2>/dev/null || true
      - echo "[UI:UP] Building images..."
      - docker compose -f docker-compose.e2e.yml build
      - echo "[UI:UP] Starting Docker stack..."
      - docker compose -f docker-compose.e2e.yml up -d --wait
      - docker compose -f docker-compose.e2e.yml ps
      - echo "[OK] UI E2E stack ready at http://localhost:3000"

  ui:down:
    desc: Stop UI E2E Docker stack
    dir: ui
    cmds:
      - echo "[UI:DOWN] Stopping Docker stack..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15
      - echo "[OK] UI E2E stack stopped"
