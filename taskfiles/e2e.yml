version: "3"

tasks:
  default:
    desc: Run e2e tests (clean, build, up, run, down)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E] Running tests..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace all
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E] Tests complete"

  check-ports:
    desc: Check if required E2E ports are available
    silent: false
    cmds:
      - |
        echo "[CHECK] Verifying ports are available..."
        if lsof -Pi :4222 -sTCP:LISTEN -t >/dev/null 2>&1; then
          echo "[ERROR] Port 4222 (NATS) is already in use:"
          lsof -Pi :4222 -sTCP:LISTEN
          exit 1
        fi
      - |
        if lsof -Pi :8222 -sTCP:LISTEN -t >/dev/null 2>&1; then
          echo "[ERROR] Port 8222 (NATS monitoring) is already in use:"
          lsof -Pi :8222 -sTCP:LISTEN
          exit 1
        fi
      - |
        if lsof -Pi :8080 -sTCP:LISTEN -t >/dev/null 2>&1; then
          echo "[ERROR] Port 8080 (semspec HTTP) is already in use:"
          lsof -Pi :8080 -sTCP:LISTEN
          exit 1
        fi
      - echo "[OK] All ports available"

  build:
    desc: Build e2e test runner
    cmds:
      - echo "[BUILD] Building e2e test runner..."
      - go build -o bin/e2e ./cmd/e2e
      - echo "[OK] Build complete"

  build-image:
    desc: Build semspec Docker image for E2E tests
    cmds:
      - echo "[BUILD-IMAGE] Building semspec Docker image..."
      - docker compose -f docker/compose/e2e.yml build semspec
      - echo "[OK] Docker image built"

  rebuild:
    desc: Force rebuild semspec Docker image (no cache)
    cmds:
      - echo "[REBUILD] Rebuilding semspec Docker image (no cache)..."
      - docker compose -f docker/compose/e2e.yml build --no-cache semspec
      - echo "[OK] Docker image rebuilt"

  clean:
    desc: Clean E2E test environment
    silent: false
    cmds:
      - echo "[E2E CLEAN] Cleaning Semspec E2E environment..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker volume ls -q --filter name=semspec | xargs -r docker volume rm 2>/dev/null || true
      - docker network ls -q --filter name=semspec-e2e | xargs -r docker network rm 2>/dev/null || true
      - echo "[OK] E2E environment cleaned"

  cleanup:
    desc: Post-test cleanup (called by defer)
    cmds:
      - echo "[E2E CLEANUP] Stopping infrastructure..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - echo "[OK] Cleanup complete"

  up:
    desc: Start e2e infrastructure (NATS + semspec) with healthcheck wait
    deps: [build-image]
    cmds:
      - echo "[E2E UP] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - docker compose -f docker/compose/e2e.yml ps
      - echo "[OK] Infrastructure ready"

  down:
    desc: Stop e2e infrastructure
    cmds:
      - docker compose -f docker/compose/e2e.yml down --timeout 15

  logs:
    desc: Show logs from e2e services
    cmds:
      - docker compose -f docker/compose/e2e.yml logs -f

  debug:
    desc: Start infrastructure and keep running for debugging
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[DEBUG] Starting infrastructure for debugging..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - docker compose -f docker/compose/e2e.yml ps
      - echo ""
      - echo "[DEBUG] Infrastructure ready. Useful commands:"
      - echo "  docker logs -f compose-semspec-1           # Watch semspec logs"
      - echo "  docker exec compose-semspec-1 ls /workspace  # Check workspace"
      - echo "  task e2e:run -- constitution               # Run specific test"
      - echo "  task e2e:down                              # Stop infrastructure"
      - echo ""
      - echo "[DEBUG] Running 'docker logs -f compose-semspec-1' in background..."
      - docker logs -f compose-semspec-1 &
      - echo "[DEBUG] Press Ctrl+C to stop watching logs"
      - sleep infinity

  logs:nats:
    desc: Show logs from NATS service
    cmds:
      - docker compose -f docker/compose/e2e.yml logs -f nats

  run:
    desc: Run e2e tests (specify scenario with -- workflow-basic)
    deps: [build]
    cmds:
      - ./bin/e2e --workspace $(pwd)/test/e2e/workspace {{.CLI_ARGS | default "all"}}

  basic:
    desc: Run only workflow-basic scenario
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:BASIC] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:BASIC] Running workflow-basic scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace workflow-basic
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:BASIC] Complete"

  constitution:
    desc: Run only constitution scenario
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:CONSTITUTION] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:CONSTITUTION] Running constitution scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace constitution
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:CONSTITUTION] Complete"

  status-cmd:
    desc: Run only status-command scenario (HTTP gateway test)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:STATUS-CMD] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:STATUS-CMD] Running status-command scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace status-command
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:STATUS-CMD] Complete"

  propose:
    desc: Run only propose-workflow scenario (HTTP gateway test)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:PROPOSE] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:PROPOSE] Running propose-workflow scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace propose-workflow
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:PROPOSE] Complete"

  workflow:
    desc: Run only full-workflow scenario (complete E2E test)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:WORKFLOW] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:WORKFLOW] Running full-workflow scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace full-workflow
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:WORKFLOW] Complete"

  ast-go:
    desc: Run only ast-go scenario (Go AST processor)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:AST-GO] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:AST-GO] Running ast-go scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace ast-go
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:AST-GO] Complete"

  ast-typescript:
    desc: Run only ast-typescript scenario (TypeScript AST processor)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:AST-TS] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:AST-TS] Running ast-typescript scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace ast-typescript
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:AST-TS] Complete"

  brownfield:
    desc: Run only brownfield scenario (existing codebase)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:BROWNFIELD] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:BROWNFIELD] Running brownfield scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace brownfield
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:BROWNFIELD] Complete"

  greenfield:
    desc: Run only greenfield scenario (new project)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:GREENFIELD] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:GREENFIELD] Running greenfield scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace greenfield
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:GREENFIELD] Complete"

  help:
    desc: Run only help-command scenario (tests /help command)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:HELP] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:HELP] Running help-command scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace help-command
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:HELP] Complete"

  context:
    desc: Run only context-command scenario (tests /context command)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:CONTEXT] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:CONTEXT] Running context-command scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace context-command
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:CONTEXT] Complete"

  graph-publish:
    desc: Run only graph-publishing scenario (tests graph entity publishing)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:GRAPH-PUBLISH] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:GRAPH-PUBLISH] Running graph-publishing scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace graph-publishing
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:GRAPH-PUBLISH] Complete"

  rdf-export:
    desc: Run only rdf-export scenario (tests /export command with RDF formats)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:RDF-EXPORT] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:RDF-EXPORT] Running rdf-export scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace rdf-export
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:RDF-EXPORT] Complete"

  status:
    desc: Check status of e2e infrastructure
    cmds:
      - echo "[STATUS] Docker containers:"
      - docker compose -f docker/compose/e2e.yml ps
      - echo ""
      - echo "[STATUS] NATS health:"
      - curl -s http://localhost:8222/healthz || echo "  NATS not available"
      - echo ""
      - echo "[STATUS] Semspec HTTP health:"
      - curl -s http://localhost:8080/readyz || echo "  Semspec not available"

  nuke:
    desc: Nuclear cleanup - remove ALL semspec docker resources
    cmds:
      - echo "[NUKE] Removing ALL Semspec Docker resources..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker ps -a --filter name=semspec --format "{{.ID}}" | xargs -r docker rm -f 2>/dev/null || true
      - docker volume ls -q --filter name=semspec | xargs -r docker volume rm 2>/dev/null || true
      - docker network ls -q --filter name=semspec | xargs -r docker network rm 2>/dev/null || true
      - docker images --filter reference='*semspec*' --format "{{.ID}}" | xargs -r docker rmi -f 2>/dev/null || true
      - echo "[OK] Nuclear cleanup complete"

  ui:
    desc: Start infrastructure and UI dev server together
    deps: [up]
    cmds:
      - echo "[UI] Starting dev server..."
      - cd ui && npm run dev

  # ============================================================================
  # UI E2E Testing Tasks
  # ============================================================================

  ui:e2e:
    desc: Run UI E2E tests with Playwright
    dir: ui
    cmds:
      - echo "[UI:E2E] Running Playwright tests..."
      - npx playwright test
      - echo "[OK] UI E2E tests complete"

  ui:e2e:ui:
    desc: Run UI E2E tests with Playwright UI mode (interactive)
    dir: ui
    cmds:
      - echo "[UI:E2E:UI] Starting Playwright UI..."
      - npx playwright test --ui

  ui:e2e:debug:
    desc: Run UI E2E tests in debug mode
    dir: ui
    cmds:
      - echo "[UI:E2E:DEBUG] Starting Playwright in debug mode..."
      - npx playwright test --debug

  ui:e2e:up:
    desc: Start UI E2E Docker stack (NATS + semspec + UI + Caddy)
    dir: ui
    cmds:
      - echo "[UI:E2E:UP] Starting Docker stack..."
      - docker compose -f docker-compose.e2e.yml up -d --wait
      - docker compose -f docker-compose.e2e.yml ps
      - echo "[OK] UI E2E stack ready at http://localhost:3000"

  ui:e2e:down:
    desc: Stop UI E2E Docker stack
    dir: ui
    cmds:
      - echo "[UI:E2E:DOWN] Stopping Docker stack..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15
      - echo "[OK] UI E2E stack stopped"

  ui:e2e:logs:
    desc: Show logs from UI E2E services
    dir: ui
    cmds:
      - docker compose -f docker-compose.e2e.yml logs -f

  ui:e2e:clean:
    desc: Clean UI E2E environment
    dir: ui
    cmds:
      - echo "[UI:E2E:CLEAN] Cleaning UI E2E environment..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker network ls -q --filter name=semspec-ui-e2e | xargs -r docker network rm 2>/dev/null || true
      - echo "[OK] UI E2E environment cleaned"

  ui:e2e:report:
    desc: Show the Playwright HTML report
    dir: ui
    cmds:
      - npx playwright show-report
