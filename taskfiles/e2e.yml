version: "3"

tasks:
  default:
    desc: Run e2e tests (clean, build, up, run, down)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E] Running tests..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace all
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E] Tests complete"

  check-ports:
    desc: Check if required E2E ports are available (semspec uses 4322, 8322, 8180, 8182)
    silent: false
    cmds:
      - |
        echo "[CHECK] Verifying semspec E2E ports are available..."
        if lsof -Pi :4322 -sTCP:LISTEN -t >/dev/null 2>&1; then
          echo "[ERROR] Port 4322 (semspec NATS) is already in use:"
          lsof -Pi :4322 -sTCP:LISTEN
          exit 1
        fi
      - |
        if lsof -Pi :8322 -sTCP:LISTEN -t >/dev/null 2>&1; then
          echo "[ERROR] Port 8322 (semspec NATS monitoring) is already in use:"
          lsof -Pi :8322 -sTCP:LISTEN
          exit 1
        fi
      - |
        if lsof -Pi :8180 -sTCP:LISTEN -t >/dev/null 2>&1; then
          echo "[ERROR] Port 8180 (semspec HTTP) is already in use:"
          lsof -Pi :8180 -sTCP:LISTEN
          exit 1
        fi
      - echo "[OK] All semspec E2E ports available"

  build:
    desc: Build e2e test runner and semspec binary
    cmds:
      - echo "[BUILD] Building semspec binary..."
      - go build -o bin/semspec ./cmd/semspec
      - echo "[BUILD] Building e2e test runner..."
      - go build -o bin/e2e ./cmd/e2e
      - echo "[OK] Build complete"

  build-clean:
    desc: Clean Go cache and rebuild all binaries
    cmds:
      - echo "[BUILD-CLEAN] Cleaning Go build cache..."
      - go clean -cache
      - echo "[BUILD-CLEAN] Building semspec binary..."
      - go build -o bin/semspec ./cmd/semspec
      - echo "[BUILD-CLEAN] Building e2e test runner..."
      - go build -o bin/e2e ./cmd/e2e
      - echo "[OK] Clean build complete"

  build-image:
    desc: Build semspec Docker image for E2E tests
    cmds:
      - echo "[BUILD-IMAGE] Building semspec Docker image..."
      - docker compose -f docker/compose/e2e.yml build semspec
      - echo "[OK] Docker image built"

  rebuild:
    desc: Force rebuild semspec Docker image (no cache)
    cmds:
      - echo "[REBUILD] Rebuilding semspec Docker image (no cache)..."
      - docker compose -f docker/compose/e2e.yml build --no-cache semspec
      - echo "[OK] Docker image rebuilt"

  clean:
    desc: Clean E2E Docker environment (containers, volumes, networks)
    silent: false
    cmds:
      - echo "[CLEAN] Cleaning Semspec E2E Docker environment..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker rm -f nats-semspec 2>/dev/null || true
      - docker volume ls -q --filter name=semspec | xargs -r docker volume rm 2>/dev/null || true
      - docker network ls -q --filter name=semspec-e2e | xargs -r docker network rm 2>/dev/null || true
      - echo "[OK] Docker environment cleaned"

  clean-go:
    desc: Clean Go build cache
    cmds:
      - echo "[CLEAN-GO] Cleaning Go build cache..."
      - go clean -cache
      - rm -f bin/semspec bin/e2e
      - echo "[OK] Go cache cleaned"

  clean-all:
    desc: Full cleanup - Go cache, Docker containers/images, binaries
    cmds:
      - echo "[CLEAN-ALL] Full cleanup starting..."
      - task: clean
      - task: clean-go
      - echo "[CLEAN-ALL] Removing semspec Docker images..."
      - docker images --filter reference='*semspec*' --format "{{.ID}}" | xargs -r docker rmi -f 2>/dev/null || true
      - echo "[OK] Full cleanup complete"

  fresh:
    desc: Full clean rebuild - cleans everything and rebuilds from scratch
    cmds:
      - task: clean-all
      - echo "[FRESH] Rebuilding from scratch..."
      - task: build-clean
      - echo "[FRESH] Rebuilding Docker image (no cache)..."
      - docker compose -f docker/compose/e2e.yml build --no-cache semspec
      - echo "[OK] Fresh build complete"

  cleanup:
    desc: Post-test cleanup (called by defer)
    cmds:
      - echo "[E2E CLEANUP] Stopping infrastructure..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - echo "[OK] Cleanup complete"

  up:
    desc: Start e2e infrastructure (NATS + semspec) with healthcheck wait
    deps: [build-image]
    cmds:
      - echo "[E2E UP] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - docker compose -f docker/compose/e2e.yml ps
      - echo "[OK] Infrastructure ready"

  down:
    desc: Stop e2e infrastructure
    cmds:
      - docker compose -f docker/compose/e2e.yml down --timeout 15

  logs:
    desc: Show logs from e2e services
    cmds:
      - docker compose -f docker/compose/e2e.yml logs -f

  debug:
    desc: Start infrastructure and keep running for debugging
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[DEBUG] Starting infrastructure for debugging..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - docker compose -f docker/compose/e2e.yml ps
      - echo ""
      - echo "[DEBUG] Infrastructure ready. Useful commands:"
      - echo "  docker logs -f compose-semspec-1           # Watch semspec logs"
      - echo "  docker exec compose-semspec-1 ls /workspace  # Check workspace"
      - echo "  task e2e:run -- plan-workflow              # Run specific test"
      - echo "  task e2e:down                              # Stop infrastructure"
      - echo ""
      - echo "[DEBUG] Running 'docker logs -f compose-semspec-1' in background..."
      - docker logs -f compose-semspec-1 &
      - echo "[DEBUG] Press Ctrl+C to stop watching logs"
      - sleep infinity

  logs:nats:
    desc: Show logs from NATS service
    cmds:
      - docker compose -f docker/compose/e2e.yml logs -f nats

  run:
    desc: Run e2e tests (specify scenario with -- workflow-basic)
    deps: [build]
    cmds:
      - ./bin/e2e --workspace $(pwd)/test/e2e/workspace {{.CLI_ARGS | default "all"}}

  status-cmd:
    desc: Run only status-command scenario (HTTP gateway test)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:STATUS-CMD] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:STATUS-CMD] Running status-command scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace status-command
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:STATUS-CMD] Complete"

  plan-workflow:
    desc: Run plan-workflow scenario (ADR-003 commands via HTTP - for UI dev)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:PLAN-WORKFLOW] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:PLAN-WORKFLOW] Running plan-workflow scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace plan-workflow
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:PLAN-WORKFLOW] Complete"

  ast-go:
    desc: Run only ast-go scenario (Go AST processor)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:AST-GO] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:AST-GO] Running ast-go scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace ast-go
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:AST-GO] Complete"

  ast-typescript:
    desc: Run only ast-typescript scenario (TypeScript AST processor)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:AST-TS] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:AST-TS] Running ast-typescript scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace ast-typescript
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:AST-TS] Complete"

  help:
    desc: Run only help-command scenario (tests /help command)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:HELP] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:HELP] Running help-command scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace help-command
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:HELP] Complete"

  context:
    desc: Run only context-command scenario (tests /context command)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:CONTEXT] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:CONTEXT] Running context-command scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace context-command
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:CONTEXT] Complete"

  graph-publish:
    desc: Run only graph-publishing scenario (tests graph entity publishing)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:GRAPH-PUBLISH] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:GRAPH-PUBLISH] Running graph-publishing scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace graph-publishing
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:GRAPH-PUBLISH] Complete"

  rdf-export:
    desc: Run only rdf-export scenario (tests /export command with RDF formats)
    deps: [clean, check-ports, build, build-image]
    cmds:
      - echo "[E2E:RDF-EXPORT] Starting infrastructure..."
      - docker compose -f docker/compose/e2e.yml up -d --wait
      - echo "[E2E:RDF-EXPORT] Running rdf-export scenario..."
      - cmd: ./bin/e2e --workspace $(pwd)/test/e2e/workspace rdf-export
        ignore_error: true
      - defer: { task: cleanup }
      - echo "[E2E:RDF-EXPORT] Complete"

  # ============================================================================
  # CLI Mode Tests (standalone NATS + local binary, no full Docker stack)
  # ============================================================================

  cli:up:
    desc: Start standalone NATS for CLI testing (semspec ports 4322, 8322)
    cmds:
      - |
        if docker ps --format '{{.Names}}' | grep -q '^nats-semspec$'; then
          echo "[CLI:UP] NATS already running"
        else
          echo "[CLI:UP] Starting standalone NATS for semspec..."
          docker rm -f nats-semspec 2>/dev/null || true
          docker run -d --name nats-semspec -p 4322:4222 -p 8322:8222 nats:2.12-alpine -js -m 8222
          echo "[CLI:UP] Waiting for NATS to be ready..."
          sleep 2
          curl -s http://localhost:8322/healthz || (echo "[ERROR] NATS not healthy" && exit 1)
        fi
      - echo "[CLI:UP] NATS ready at localhost:4322"

  cli:down:
    desc: Stop CLI NATS infrastructure (semspec)
    cmds:
      - echo "[CLI:DOWN] Stopping semspec CLI infrastructure..."
      - docker rm -f nats-semspec 2>/dev/null || true
      - echo "[CLI:DOWN] Stopped"

  cli:check-ports:
    desc: Check if semspec CLI ports (8180, 8182, 4322) are available or used by our infra
    cmds:
      - |
        echo "[CLI:CHECK] Checking semspec port availability..."
        FAIL=0
        for PORT in 8180 8182; do
          if lsof -Pi :$PORT -sTCP:LISTEN -t >/dev/null 2>&1; then
            echo "[ERROR] Port $PORT is in use:"
            lsof -Pi :$PORT -sTCP:LISTEN
            FAIL=1
          fi
        done
        if [ $FAIL -eq 1 ]; then
          echo "[ERROR] Some ports are in use. Run 'task e2e:cli:down' or kill conflicting processes."
          exit 1
        fi
        echo "[CLI:CHECK] Semspec ports 8180, 8182 available"
      - |
        # Port 4322 should be used by our NATS
        if ! docker ps --format '{{.Names}}' | grep -q '^nats-semspec$'; then
          if lsof -Pi :4322 -sTCP:LISTEN -t >/dev/null 2>&1; then
            echo "[WARN] Port 4322 in use but not by nats-semspec container"
            lsof -Pi :4322 -sTCP:LISTEN
          fi
        fi

  cli:fresh:
    desc: Clean rebuild for CLI tests (use when tests behave unexpectedly)
    cmds:
      - task: cli:down
      - task: clean-go
      - task: build
      - task: cli:up
      - echo "[CLI:FRESH] Ready for testing"

  cli:plan-workflow:
    desc: Run CLI plan workflow test (ADR-003 commands)
    deps: [build, cli:up, cli:check-ports]
    env:
      NATS_URL: nats://localhost:4322
    cmds:
      - echo "[CLI:PLAN-WORKFLOW] Running CLI plan workflow scenario..."
      - NATS_URL=nats://localhost:4322 ./bin/e2e --config ./configs/semspec.json --workspace $(pwd)/test/e2e/workspace cli-plan-workflow

  cli:smoke:
    desc: Run CLI smoke test (plan-workflow)
    deps: [build, cli:up, cli:check-ports]
    env:
      NATS_URL: nats://localhost:4322
    cmds:
      - echo "[CLI:SMOKE] Running CLI plan-workflow test..."
      - NATS_URL=nats://localhost:4322 ./bin/e2e --config ./configs/semspec.json --workspace $(pwd)/test/e2e/workspace cli-plan-workflow
      - echo "[CLI:SMOKE] Complete"

  cli:test-manual:
    desc: Test CLI manually with /help command (for debugging)
    deps: [build, cli:up, cli:check-ports]
    cmds:
      - |
        echo "[CLI:TEST] Sending /help to CLI with minimal config..."
        echo -e "/help\n/quit" | timeout 15 ./bin/semspec cli \
          --config ./configs/cli-test.json \
          --repo ./test/e2e/workspace \
          --log-level info 2>&1
        echo "[CLI:TEST] Done"

  status:
    desc: Check status of e2e infrastructure (semspec ports)
    cmds:
      - echo "[STATUS] Docker containers:"
      - docker compose -f docker/compose/e2e.yml ps
      - echo ""
      - echo "[STATUS] NATS health (port 8322):"
      - curl -s http://localhost:8322/healthz || echo "  NATS not available"
      - echo ""
      - echo "[STATUS] Semspec HTTP health (port 8180):"
      - curl -s http://localhost:8180/readyz || echo "  Semspec not available"

  nuke:
    desc: Nuclear cleanup - remove ALL semspec docker resources
    cmds:
      - echo "[NUKE] Removing ALL Semspec Docker resources..."
      - docker compose -f docker/compose/e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker ps -a --filter name=semspec --format "{{.ID}}" | xargs -r docker rm -f 2>/dev/null || true
      - docker volume ls -q --filter name=semspec | xargs -r docker volume rm 2>/dev/null || true
      - docker network ls -q --filter name=semspec | xargs -r docker network rm 2>/dev/null || true
      - docker images --filter reference='*semspec*' --format "{{.ID}}" | xargs -r docker rmi -f 2>/dev/null || true
      - echo "[OK] Nuclear cleanup complete"

  ui:
    desc: Start infrastructure and UI dev server together
    deps: [up]
    cmds:
      - echo "[UI] Starting dev server..."
      - cd ui && npm run dev

  # ============================================================================
  # UI E2E Testing Tasks
  # ============================================================================

  ui:e2e:
    desc: Run UI E2E tests with Playwright
    dir: ui
    cmds:
      - echo "[UI:E2E] Running Playwright tests..."
      - npx playwright test
      - echo "[OK] UI E2E tests complete"

  ui:e2e:ui:
    desc: Run UI E2E tests with Playwright UI mode (interactive)
    dir: ui
    cmds:
      - echo "[UI:E2E:UI] Starting Playwright UI..."
      - npx playwright test --ui

  ui:e2e:debug:
    desc: Run UI E2E tests in debug mode
    dir: ui
    cmds:
      - echo "[UI:E2E:DEBUG] Starting Playwright in debug mode..."
      - npx playwright test --debug

  ui:e2e:up:
    desc: Start UI E2E Docker stack (clean volumes, rebuild, wait for healthy)
    dir: ui
    cmds:
      - echo "[UI:E2E:UP] Cleaning stale state..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15 2>/dev/null || true
      - echo "[UI:E2E:UP] Building images..."
      - docker compose -f docker-compose.e2e.yml build
      - echo "[UI:E2E:UP] Starting Docker stack..."
      - docker compose -f docker-compose.e2e.yml up -d --wait
      - docker compose -f docker-compose.e2e.yml ps
      - echo "[OK] UI E2E stack ready at http://localhost:3000"

  ui:e2e:fresh:
    desc: Nuclear clean + no-cache rebuild + start (guaranteed clean state)
    dir: ui
    cmds:
      - echo "[UI:E2E:FRESH] Nuclear cleanup..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker volume ls -q --filter name=semspec-ui | xargs -r docker volume rm 2>/dev/null || true
      - docker network ls -q --filter name=semspec-ui-e2e | xargs -r docker network rm 2>/dev/null || true
      - echo "[UI:E2E:FRESH] Rebuilding all images (no cache)..."
      - docker compose -f docker-compose.e2e.yml build --no-cache
      - echo "[UI:E2E:FRESH] Starting Docker stack..."
      - docker compose -f docker-compose.e2e.yml up -d --wait
      - docker compose -f docker-compose.e2e.yml ps
      - echo "[OK] UI E2E stack ready at http://localhost:3000 (clean state)"

  ui:e2e:down:
    desc: Stop UI E2E Docker stack and remove volumes
    dir: ui
    cmds:
      - echo "[UI:E2E:DOWN] Stopping Docker stack..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15
      - echo "[OK] UI E2E stack stopped"

  ui:e2e:logs:
    desc: Show logs from UI E2E services
    dir: ui
    cmds:
      - docker compose -f docker-compose.e2e.yml logs -f

  ui:e2e:clean:
    desc: Clean UI E2E environment (containers, volumes, networks)
    dir: ui
    cmds:
      - echo "[UI:E2E:CLEAN] Cleaning UI E2E environment..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker network ls -q --filter name=semspec-ui-e2e | xargs -r docker network rm 2>/dev/null || true
      - echo "[OK] UI E2E environment cleaned"

  ui:e2e:nuke:
    desc: Nuclear cleanup - remove ALL UI E2E Docker resources including images
    dir: ui
    cmds:
      - echo "[UI:E2E:NUKE] Removing ALL UI E2E Docker resources..."
      - docker compose -f docker-compose.e2e.yml down -v --timeout 15 2>/dev/null || true
      - docker volume ls -q --filter name=semspec-ui | xargs -r docker volume rm 2>/dev/null || true
      - docker network ls -q --filter name=semspec-ui-e2e | xargs -r docker network rm 2>/dev/null || true
      - docker compose -f docker-compose.e2e.yml config --images 2>/dev/null | xargs -r docker rmi -f 2>/dev/null || true
      - echo "[OK] Nuclear cleanup complete"

  ui:e2e:report:
    desc: Show the Playwright HTML report
    dir: ui
    cmds:
      - npx playwright show-report
