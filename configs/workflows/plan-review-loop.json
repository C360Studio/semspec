{
  "id": "plan-review-loop",
  "name": "Plan Review OODA Loop",
  "description": "Planner/Reviewer feedback loop for plan generation (ADR-005, ADR-020). Observe (context-builder) → Orient (planner) → Decide (plan-reviewer) → Act (approve or revise with feedback).",
  "version": "2.0.0",
  "enabled": true,
  "trigger": {
    "subject": "workflow.trigger.plan-review-loop"
  },
  "steps": [
    {
      "name": "planner",
      "inputs": {
        "workflow_id": {"from": "trigger.payload.workflow_id"},
        "role": {"from": "trigger.payload.role"},
        "prompt": {"from": "trigger.payload.prompt"},
        "request_id": {"from": "trigger.payload.request_id"},
        "trace_id": {"from": "trigger.payload.trace_id"},
        "slug": {"from": "trigger.payload.slug"},
        "title": {"from": "trigger.payload.title"},
        "description": {"from": "trigger.payload.description"}
      },
      "outputs": {
        "content": {},
        "llm_request_ids": {}
      },
      "action": {
        "type": "publish_async",
        "subject": "workflow.async.planner"
      },
      "on_success": "plan_reviewer",
      "on_fail": "planner_failed",
      "timeout": "5m"
    },
    {
      "name": "plan_reviewer",
      "inputs": {
        "request_id": {"from": "trigger.payload.request_id"},
        "trace_id": {"from": "trigger.payload.trace_id"},
        "slug": {"from": "trigger.payload.slug"},
        "project_id": {"from": "trigger.payload.project_id"},
        "plan_content": {"from": "planner.content"},
        "scope_patterns": {"from": "planner.content.scope.include"}
      },
      "outputs": {
        "verdict": {},
        "summary": {},
        "findings": {},
        "formatted_findings": {},
        "llm_request_ids": {}
      },
      "action": {
        "type": "publish_async",
        "subject": "workflow.async.plan-reviewer"
      },
      "on_success": "verdict_check",
      "on_fail": "reviewer_failed",
      "timeout": "5m"
    },
    {
      "name": "verdict_check",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "verdict": {"template": "approved"},
        "summary": {"from": "plan_reviewer.summary"},
        "llm_request_ids": {"from": "plan_reviewer.llm_request_ids"}
      },
      "condition": {
        "field": "${steps.plan_reviewer.output.verdict}",
        "operator": "eq",
        "value": "approved"
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.plan.approved"
      },
      "on_success": "complete",
      "on_fail": "check_retry"
    },
    {
      "name": "check_retry",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "iteration": {"from": "execution.iteration"},
        "verdict": {"from": "plan_reviewer.verdict"},
        "findings": {"from": "plan_reviewer.findings"},
        "llm_request_ids": {"from": "plan_reviewer.llm_request_ids"}
      },
      "condition": {
        "field": "${execution.iteration}",
        "operator": "lt",
        "value": 3
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.plan.revision_needed"
      },
      "on_success": "revise_planner",
      "on_fail": "max_revisions_exceeded"
    },
    {
      "name": "revise_planner",
      "inputs": {
        "workflow_id": {"from": "trigger.payload.workflow_id"},
        "role": {"from": "trigger.payload.role"},
        "prompt": {"template": "REVISION REQUEST: Your previous plan was rejected by the reviewer.\n\n## Review Summary\n\n${steps.plan_reviewer.output.summary}\n\n## Specific Findings\n\n${steps.plan_reviewer.output.formatted_findings}\n\n## Instructions\n\nAddress ALL issues raised by the reviewer. For each violation, update the plan's scope.include to add the missing files or directories. Produce an updated Goal/Context/Scope JSON that resolves every finding. Do not ignore any feedback."},
        "request_id": {"from": "trigger.payload.request_id"},
        "trace_id": {"from": "trigger.payload.trace_id"},
        "slug": {"from": "trigger.payload.slug"},
        "title": {"from": "trigger.payload.title"},
        "description": {"from": "trigger.payload.description"}
      },
      "action": {
        "type": "publish_async",
        "subject": "workflow.async.planner"
      },
      "on_success": "plan_reviewer",
      "on_fail": "planner_failed",
      "timeout": "5m"
    },
    {
      "name": "max_revisions_exceeded",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "reason": {"template": "Plan review loop exceeded max revisions after ${execution.iteration} attempts"},
        "last_verdict": {"from": "plan_reviewer.verdict"},
        "last_findings": {"from": "plan_reviewer.findings"},
        "formatted_findings": {"from": "plan_reviewer.formatted_findings"},
        "iteration": {"from": "execution.iteration"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.escalate"
      },
      "on_success": "complete"
    },
    {
      "name": "planner_failed",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "error": {"template": "Planner failed: ${steps.planner.error}"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.error"
      },
      "on_success": "complete"
    },
    {
      "name": "reviewer_failed",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "error": {"template": "Plan reviewer failed: ${steps.plan_reviewer.error}"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.error"
      },
      "on_success": "complete"
    },
    {
      "name": "complete",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "iterations": {"from": "execution.iteration"}
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.plan.review_complete"
      }
    }
  ],
  "timeout": "30m",
  "max_iterations": 3
}
