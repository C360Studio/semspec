{
  "id": "task-execution-loop",
  "name": "Task Execution OODA Loop",
  "description": "Developer → Structural Validation → Reviewer adversarial loop for task execution (ADR-003, ADR-005, ADR-020)",
  "version": "2.0.0",
  "enabled": true,
  "trigger": {
    "subject": "workflow.trigger.task-execution-loop"
  },
  "steps": [
    {
      "name": "developer",
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.development",
        "role": "developer",
        "model": "${trigger.payload.model:-qwen}",
        "prompt": "Implement task ${trigger.payload.task_id}: ${trigger.payload.prompt}"
      },
      "on_success": "validate_structure",
      "on_fail": "developer_failed",
      "timeout": "10m"
    },
    {
      "name": "validate_structure",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "task_id": {"from": "trigger.payload.task_id"},
        "workflow_id": {"from": "trigger.payload.workflow_id"}
      },
      "outputs": {
        "passed": {},
        "checks_run": {},
        "check_results": {}
      },
      "action": {
        "type": "publish_async",
        "subject": "workflow.async.structural-validator"
      },
      "on_success": "validation_verdict",
      "on_fail": "validation_error",
      "timeout": "5m"
    },
    {
      "name": "validation_verdict",
      "inputs": {
        "task_id": {"from": "trigger.payload.task_id"},
        "checks_run": {"from": "validate_structure.checks_run"}
      },
      "condition": {
        "field": "${steps.validate_structure.output.passed}",
        "operator": "eq",
        "value": true
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.task.validation_passed"
      },
      "on_success": "reviewer",
      "on_fail": "validation_fix"
    },
    {
      "name": "validation_fix",
      "condition": {
        "field": "${execution.iteration}",
        "operator": "lt",
        "value": 3
      },
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.development",
        "role": "developer",
        "model": "${trigger.payload.model:-qwen}",
        "prompt": "STRUCTURAL VALIDATION FAILED for task ${trigger.payload.task_id}. The code does not pass the project's quality checks.\n\n## Failed Checks\n\n${steps.validate_structure.output.check_results}\n\n## Instructions\n\nFix ALL failing checks (build errors, lint violations, test failures) and resubmit."
      },
      "on_success": "validate_structure",
      "on_fail": "validation_escalate"
    },
    {
      "name": "validation_escalate",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "task_id": {"from": "trigger.payload.task_id"},
        "reason": {"template": "Structural validation failed after max retries"},
        "check_results": {"from": "validate_structure.check_results"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.escalate"
      },
      "on_success": "complete"
    },
    {
      "name": "validation_error",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "task_id": {"from": "trigger.payload.task_id"},
        "error": {"template": "Structural validator error: ${steps.validate_structure.error}"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.error"
      },
      "on_success": "complete"
    },
    {
      "name": "reviewer",
      "outputs": {
        "verdict": {},
        "rejection_type": {},
        "feedback": {},
        "patterns": {}
      },
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.review",
        "role": "reviewer",
        "model": "${trigger.payload.model:-qwen}",
        "prompt": "Review the developer's implementation for task ${trigger.payload.task_id}. Evaluate code quality, correctness, and adherence to the task requirements."
      },
      "on_success": "verdict_check",
      "on_fail": "reviewer_failed",
      "timeout": "5m"
    },
    {
      "name": "verdict_check",
      "inputs": {
        "task_id": {"from": "trigger.payload.task_id"},
        "status": {"template": "approved"},
        "patterns": {"from": "reviewer.patterns"}
      },
      "condition": {
        "field": "${steps.reviewer.output.verdict}",
        "operator": "eq",
        "value": "approved"
      },
      "action": {
        "type": "publish",
        "subject": "workflow.task.complete"
      },
      "on_success": "complete",
      "on_fail": "categorize_rejection"
    },
    {
      "name": "categorize_rejection",
      "inputs": {
        "type": {"template": "fixable"}
      },
      "condition": {
        "field": "${steps.reviewer.output.rejection_type}",
        "operator": "eq",
        "value": "fixable"
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.task.rejection_categorized"
      },
      "on_success": "retry_developer",
      "on_fail": "check_misscoped"
    },
    {
      "name": "check_misscoped",
      "inputs": {
        "original_task_id": {"from": "trigger.payload.task_id"},
        "feedback": {"from": "reviewer.feedback"},
        "plan_slug": {"from": "trigger.payload.slug"},
        "rejection_type": {"from": "reviewer.rejection_type"}
      },
      "condition": {
        "field": "${steps.reviewer.output.rejection_type}",
        "operator": "in",
        "value": ["misscoped", "architectural"]
      },
      "action": {
        "type": "publish",
        "subject": "workflow.trigger.plan-refinement"
      },
      "on_success": "complete",
      "on_fail": "check_too_big"
    },
    {
      "name": "check_too_big",
      "inputs": {
        "original_task_id": {"from": "trigger.payload.task_id"},
        "feedback": {"from": "reviewer.feedback"},
        "plan_slug": {"from": "trigger.payload.slug"}
      },
      "condition": {
        "field": "${steps.reviewer.output.rejection_type}",
        "operator": "eq",
        "value": "too_big"
      },
      "action": {
        "type": "publish",
        "subject": "workflow.trigger.task-decomposition"
      },
      "on_success": "complete",
      "on_fail": "escalate"
    },
    {
      "name": "retry_developer",
      "condition": {
        "field": "${execution.iteration}",
        "operator": "lt",
        "value": 3
      },
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.development",
        "role": "developer",
        "model": "${trigger.payload.model:-qwen}",
        "prompt": "REVISION REQUEST for task ${trigger.payload.task_id}: Your previous implementation was rejected.\n\n## Reviewer Feedback\n\n${steps.reviewer.output.feedback}\n\n## Instructions\n\nAddress ALL issues raised by the reviewer and resubmit."
      },
      "on_success": "validate_structure",
      "on_fail": "max_retries_exceeded"
    },
    {
      "name": "max_retries_exceeded",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "task_id": {"from": "trigger.payload.task_id"},
        "reason": {"template": "Max retries exceeded after ${execution.iteration} attempts"},
        "last_feedback": {"from": "reviewer.feedback"},
        "iteration": {"from": "execution.iteration"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.escalate"
      },
      "on_success": "complete"
    },
    {
      "name": "escalate",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "task_id": {"from": "trigger.payload.task_id"},
        "reason": {"template": "Unknown rejection type: ${steps.reviewer.output.rejection_type}"},
        "feedback": {"from": "reviewer.feedback"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.escalate"
      },
      "on_success": "complete"
    },
    {
      "name": "developer_failed",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "task_id": {"from": "trigger.payload.task_id"},
        "error": {"template": "Developer agent failed: ${steps.developer.error}"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.error"
      },
      "on_success": "complete"
    },
    {
      "name": "reviewer_failed",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "task_id": {"from": "trigger.payload.task_id"},
        "error": {"template": "Reviewer agent failed: ${steps.reviewer.error}"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.error"
      },
      "on_success": "complete"
    },
    {
      "name": "complete",
      "inputs": {
        "task_id": {"from": "trigger.payload.task_id"},
        "iterations": {"from": "execution.iteration"}
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.task.execution_complete"
      }
    }
  ],
  "timeout": "30m",
  "max_iterations": 3
}
