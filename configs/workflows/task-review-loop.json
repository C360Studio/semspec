{
  "id": "task-review-loop",
  "name": "Task Review OODA Loop",
  "description": "Task generation/review feedback loop for SOP compliance. Generate tasks → Review → Approve or revise with feedback.",
  "version": "1.0.0",
  "enabled": true,
  "trigger": {
    "subject": "workflow.trigger.task-review-loop"
  },
  "steps": [
    {
      "name": "task_generator",
      "action": {
        "type": "publish_async",
        "subject": "workflow.trigger.task-generator",
        "payload": {
          "workflow_id": "task-review-loop",
          "role": "task-generator",
          "prompt": "${trigger.payload.prompt}",
          "request_id": "${trigger.payload.request_id}",
          "trace_id": "${trigger.payload.trace_id}",
          "data": {
            "slug": "${trigger.payload.slug}",
            "title": "${trigger.payload.title}",
            "description": "${trigger.payload.description}"
          }
        }
      },
      "on_success": "task_reviewer",
      "on_fail": "generator_failed",
      "timeout": "5m"
    },
    {
      "name": "task_reviewer",
      "action": {
        "type": "publish_async",
        "subject": "workflow.trigger.task-reviewer",
        "payload": {
          "request_id": "${trigger.payload.request_id}",
          "trace_id": "${trigger.payload.trace_id}",
          "slug": "${trigger.payload.slug}",
          "project_id": "${trigger.payload.project_id}",
          "tasks": "${steps.task_generator.output.tasks}",
          "scope_patterns": "${trigger.payload.scope_patterns}"
        }
      },
      "on_success": "verdict_check",
      "on_fail": "reviewer_failed",
      "timeout": "5m"
    },
    {
      "name": "verdict_check",
      "condition": {
        "field": "${steps.task_reviewer.output.verdict}",
        "operator": "eq",
        "value": "approved"
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events",
        "payload": {
          "event": "tasks_approved",
          "slug": "${trigger.payload.slug}",
          "verdict": "approved",
          "summary": "${steps.task_reviewer.output.summary}",
          "task_count": "${steps.task_generator.output.task_count}"
        }
      },
      "on_success": "complete",
      "on_fail": "check_retry"
    },
    {
      "name": "check_retry",
      "condition": {
        "field": "${execution.iteration}",
        "operator": "lt",
        "value": 3
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events",
        "payload": {
          "event": "tasks_revision_needed",
          "slug": "${trigger.payload.slug}",
          "iteration": "${execution.iteration}",
          "verdict": "${steps.task_reviewer.output.verdict}",
          "findings": "${steps.task_reviewer.output.findings}"
        }
      },
      "on_success": "revise_tasks",
      "on_fail": "max_revisions_exceeded"
    },
    {
      "name": "revise_tasks",
      "action": {
        "type": "publish_async",
        "subject": "workflow.trigger.task-generator",
        "payload": {
          "workflow_id": "task-review-loop",
          "role": "task-generator",
          "prompt": "REVISION REQUEST: Your previous tasks were rejected by the reviewer.\n\n## Review Summary\n\n${steps.task_reviewer.output.summary}\n\n## Specific Findings\n\n${steps.task_reviewer.output.formatted_findings}\n\n## Original Request\n\n${trigger.payload.prompt}\n\n## Instructions\n\nAddress ALL issues raised by the reviewer. For each violation:\n- If tests are required by an SOP, add a task with type='test'\n- If documentation is required, add a task with type='document'\n- Ensure all tasks have Given/When/Then acceptance criteria\n- Verify depends_on references are valid\n\nProduce an updated task list that resolves every finding. Do not ignore any feedback.",
          "request_id": "${trigger.payload.request_id}",
          "trace_id": "${trigger.payload.trace_id}",
          "data": {
            "slug": "${trigger.payload.slug}",
            "title": "${trigger.payload.title}",
            "description": "${trigger.payload.description}",
            "revision": true,
            "previous_findings": "${steps.task_reviewer.output.formatted_findings}"
          }
        }
      },
      "on_success": "task_reviewer",
      "on_fail": "generator_failed",
      "timeout": "5m"
    },
    {
      "name": "max_revisions_exceeded",
      "action": {
        "type": "publish",
        "subject": "user.signal.escalate",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "reason": "Task review loop exceeded max revisions after ${execution.iteration} attempts",
          "last_verdict": "${steps.task_reviewer.output.verdict}",
          "last_findings": "${steps.task_reviewer.output.findings}"
        }
      },
      "on_success": "complete"
    },
    {
      "name": "generator_failed",
      "action": {
        "type": "publish",
        "subject": "user.signal.error",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "error": "Task generator failed: ${steps.task_generator.error}"
        }
      },
      "on_success": "complete"
    },
    {
      "name": "reviewer_failed",
      "action": {
        "type": "publish",
        "subject": "user.signal.error",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "error": "Task reviewer failed: ${steps.task_reviewer.error}"
        }
      },
      "on_success": "complete"
    },
    {
      "name": "complete",
      "action": {
        "type": "publish",
        "subject": "workflow.events",
        "payload": {
          "event": "task_review_loop_complete",
          "slug": "${trigger.payload.slug}",
          "iterations": "${execution.iteration}"
        }
      }
    }
  ],
  "timeout": "30m",
  "max_iterations": 3
}
