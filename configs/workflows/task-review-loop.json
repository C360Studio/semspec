{
  "id": "task-review-loop",
  "name": "Task Review OODA Loop",
  "description": "Task generation/review feedback loop for SOP compliance (ADR-005, ADR-020). Generate tasks → Review → Approve or revise with feedback.",
  "version": "2.0.0",
  "enabled": true,
  "trigger": {
    "subject": "workflow.trigger.task-review-loop"
  },
  "steps": [
    {
      "name": "task_generator",
      "inputs": {
        "workflow_id": {"from": "trigger.payload.workflow_id"},
        "role": {"from": "trigger.payload.role"},
        "prompt": {"from": "trigger.payload.prompt"},
        "request_id": {"from": "trigger.payload.request_id"},
        "trace_id": {"from": "trigger.payload.trace_id"},
        "slug": {"from": "trigger.payload.slug"},
        "title": {"from": "trigger.payload.title"},
        "description": {"from": "trigger.payload.description"}
      },
      "outputs": {
        "tasks": {},
        "task_count": {}
      },
      "action": {
        "type": "publish_async",
        "subject": "workflow.async.task-generator"
      },
      "on_success": "task_reviewer",
      "on_fail": "generator_failed",
      "timeout": "5m"
    },
    {
      "name": "task_reviewer",
      "inputs": {
        "request_id": {"from": "trigger.payload.request_id"},
        "trace_id": {"from": "trigger.payload.trace_id"},
        "slug": {"from": "trigger.payload.slug"},
        "project_id": {"from": "trigger.payload.project_id"},
        "tasks": {"from": "task_generator.tasks"},
        "scope_patterns": {"from": "trigger.payload.scope_patterns"}
      },
      "outputs": {
        "verdict": {},
        "summary": {},
        "findings": {},
        "formatted_findings": {},
        "task_count": {}
      },
      "action": {
        "type": "publish_async",
        "subject": "workflow.async.task-reviewer"
      },
      "on_success": "verdict_check",
      "on_fail": "reviewer_failed",
      "timeout": "5m"
    },
    {
      "name": "verdict_check",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "verdict": {"template": "approved"},
        "summary": {"from": "task_reviewer.summary"},
        "task_count": {"from": "task_generator.task_count"}
      },
      "condition": {
        "field": "${steps.task_reviewer.output.verdict}",
        "operator": "eq",
        "value": "approved"
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.tasks.approved"
      },
      "on_success": "complete",
      "on_fail": "check_retry"
    },
    {
      "name": "check_retry",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "iteration": {"from": "execution.iteration"},
        "verdict": {"from": "task_reviewer.verdict"},
        "findings": {"from": "task_reviewer.findings"}
      },
      "condition": {
        "field": "${execution.iteration}",
        "operator": "lt",
        "value": 3
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.tasks.revision_needed"
      },
      "on_success": "revise_tasks",
      "on_fail": "max_revisions_exceeded"
    },
    {
      "name": "revise_tasks",
      "inputs": {
        "workflow_id": {"from": "trigger.payload.workflow_id"},
        "role": {"from": "trigger.payload.role"},
        "prompt": {"template": "REVISION REQUEST: Your previous tasks were rejected by the reviewer.\n\n## Review Summary\n\n${steps.task_reviewer.output.summary}\n\n## Specific Findings\n\n${steps.task_reviewer.output.formatted_findings}\n\n## Original Request\n\n${trigger.payload.prompt}\n\n## Instructions\n\nAddress ALL issues raised by the reviewer. For each violation:\n- If tests are required by an SOP, add a task with type='test'\n- If documentation is required, add a task with type='document'\n- Ensure all tasks have Given/When/Then acceptance criteria\n- Verify depends_on references are valid\n\nProduce an updated task list that resolves every finding. Do not ignore any feedback."},
        "request_id": {"from": "trigger.payload.request_id"},
        "trace_id": {"from": "trigger.payload.trace_id"},
        "slug": {"from": "trigger.payload.slug"},
        "title": {"from": "trigger.payload.title"},
        "description": {"from": "trigger.payload.description"},
        "revision": {"template": "true"},
        "previous_findings": {"from": "task_reviewer.formatted_findings"}
      },
      "action": {
        "type": "publish_async",
        "subject": "workflow.async.task-generator"
      },
      "on_success": "task_reviewer",
      "on_fail": "generator_failed",
      "timeout": "5m"
    },
    {
      "name": "max_revisions_exceeded",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "reason": {"template": "Task review loop exceeded max revisions after ${execution.iteration} attempts"},
        "last_verdict": {"from": "task_reviewer.verdict"},
        "last_findings": {"from": "task_reviewer.findings"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.escalate"
      },
      "on_success": "complete"
    },
    {
      "name": "generator_failed",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "error": {"template": "Task generator failed: ${steps.task_generator.error}"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.error"
      },
      "on_success": "complete"
    },
    {
      "name": "reviewer_failed",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "error": {"template": "Task reviewer failed: ${steps.task_reviewer.error}"}
      },
      "action": {
        "type": "publish",
        "subject": "user.signal.error"
      },
      "on_success": "complete"
    },
    {
      "name": "complete",
      "inputs": {
        "slug": {"from": "trigger.payload.slug"},
        "iterations": {"from": "execution.iteration"}
      },
      "action": {
        "type": "publish",
        "subject": "workflow.events.tasks.review_complete"
      }
    }
  ],
  "timeout": "30m",
  "max_iterations": 3
}
