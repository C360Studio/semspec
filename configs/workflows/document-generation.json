{
  "id": "document-generation",
  "name": "Proposal to Tasks Workflow",
  "description": "Generates workflow documents (proposal, design, spec, tasks) with validation and auto-continue support",
  "version": "1.0.0",
  "enabled": true,
  "trigger": {
    "subject": "workflow.trigger.document-generation"
  },
  "steps": [
    {
      "name": "generate_proposal",
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.workflow",
        "role": "proposal-writer",
        "model": "${trigger.payload.model}",
        "prompt": "${trigger.payload.prompt}",
        "payload": {
          "workflow_slug": "${trigger.payload.slug}",
          "workflow_step": "propose",
          "title": "${trigger.payload.title}",
          "description": "${trigger.payload.description}",
          "auto_continue": "${trigger.payload.auto}",
          "user_id": "${trigger.payload.user_id}",
          "channel_type": "${trigger.payload.channel_type}",
          "channel_id": "${trigger.payload.channel_id}"
        }
      },
      "on_success": "validate_proposal",
      "on_fail": "generation_failed",
      "timeout": "5m"
    },
    {
      "name": "validate_proposal",
      "action": {
        "type": "call",
        "subject": "workflow.validate.proposal",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "document": "proposal",
          "content": "${steps.generate_proposal.output.content}"
        }
      },
      "on_success": "publish_proposal_to_graph",
      "on_fail": "retry_proposal",
      "timeout": "30s"
    },
    {
      "name": "publish_proposal_to_graph",
      "condition": {
        "field": "${steps.validate_proposal.output.valid}",
        "operator": "eq",
        "value": true
      },
      "action": {
        "type": "publish",
        "subject": "graph.ingest.entity",
        "payload": {
          "id": "semspec.local.workflow.proposal.${trigger.payload.slug}",
          "triples": [
            {"predicate": "semspec.proposal.title", "object": "${trigger.payload.title}"},
            {"predicate": "semspec.proposal.content", "object": "${steps.generate_proposal.output.content}"},
            {"predicate": "semspec.proposal.status", "object": "proposed"},
            {"predicate": "dc.terms.creator", "object": "${trigger.payload.user_id}"},
            {"predicate": "dc.terms.created", "object": "${execution.started_at}"}
          ]
        }
      },
      "on_success": "export_proposal_to_file",
      "on_fail": "retry_proposal"
    },
    {
      "name": "retry_proposal",
      "condition": {
        "field": "${execution.iteration}",
        "operator": "lt",
        "value": 3
      },
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.workflow",
        "role": "proposal-writer",
        "model": "${trigger.payload.model}",
        "prompt": "Previous attempt failed validation: ${steps.validate_proposal.output.feedback}\n\nPlease fix and regenerate the proposal.",
        "payload": {
          "workflow_slug": "${trigger.payload.slug}",
          "workflow_step": "propose",
          "title": "${trigger.payload.title}",
          "description": "${trigger.payload.description}",
          "retry_attempt": "${execution.iteration}",
          "user_id": "${trigger.payload.user_id}",
          "channel_type": "${trigger.payload.channel_type}",
          "channel_id": "${trigger.payload.channel_id}"
        }
      },
      "on_success": "validate_proposal",
      "on_fail": "generation_failed",
      "timeout": "5m"
    },
    {
      "name": "export_proposal_to_file",
      "action": {
        "type": "publish",
        "subject": "output.workflow.documents",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "document": "proposal",
          "content": "${steps.generate_proposal.output}",
          "entity_id": "semspec.local.workflow.proposal.${trigger.payload.slug}",
          "user_id": "${trigger.payload.user_id}",
          "channel_type": "${trigger.payload.channel_type}",
          "channel_id": "${trigger.payload.channel_id}"
        }
      },
      "on_success": "generate_design"
    },
    {
      "name": "generate_design",
      "condition": {
        "field": "${trigger.payload.auto}",
        "operator": "eq",
        "value": true
      },
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.workflow",
        "role": "design-writer",
        "model": "${trigger.payload.model}",
        "prompt": "Generate a technical design document based on the proposal for: ${trigger.payload.title}",
        "payload": {
          "workflow_slug": "${trigger.payload.slug}",
          "workflow_step": "design",
          "title": "${trigger.payload.title}",
          "previous_entities": ["semspec.local.workflow.proposal.${trigger.payload.slug}"],
          "auto_continue": "${trigger.payload.auto}",
          "user_id": "${trigger.payload.user_id}",
          "channel_type": "${trigger.payload.channel_type}",
          "channel_id": "${trigger.payload.channel_id}"
        }
      },
      "on_success": "validate_design",
      "on_fail": "notify_proposal_complete",
      "timeout": "5m"
    },
    {
      "name": "notify_proposal_complete",
      "action": {
        "type": "publish",
        "subject": "user.response.${trigger.payload.channel_type}.${trigger.payload.channel_id}",
        "payload": {
          "type": "result",
          "content": "Proposal generated successfully for **${trigger.payload.title}**.\n\nReview it at `.semspec/changes/${trigger.payload.slug}/proposal.md`\n\nRun `/design ${trigger.payload.slug}` to continue to the design phase."
        }
      },
      "on_success": "complete"
    },
    {
      "name": "validate_design",
      "action": {
        "type": "call",
        "subject": "workflow.validate.design",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "document": "design",
          "content": "${steps.generate_design.output.content}"
        }
      },
      "on_success": "publish_design_to_graph",
      "on_fail": "design_failed",
      "timeout": "30s"
    },
    {
      "name": "publish_design_to_graph",
      "condition": {
        "field": "${steps.validate_design.output.valid}",
        "operator": "eq",
        "value": true
      },
      "action": {
        "type": "publish",
        "subject": "graph.ingest.entity",
        "payload": {
          "id": "semspec.local.workflow.design.${trigger.payload.slug}",
          "triples": [
            {"predicate": "semspec.design.title", "object": "${trigger.payload.title}"},
            {"predicate": "semspec.design.content", "object": "${steps.generate_design.output.content}"},
            {"predicate": "semspec.design.status", "object": "designed"},
            {"predicate": "prov.was_derived_from", "object": "semspec.local.workflow.proposal.${trigger.payload.slug}"},
            {"predicate": "dc.terms.created", "object": "${execution.started_at}"}
          ]
        }
      },
      "on_success": "export_design_to_file",
      "on_fail": "design_failed"
    },
    {
      "name": "export_design_to_file",
      "action": {
        "type": "publish",
        "subject": "output.workflow.documents",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "document": "design",
          "content": "${steps.generate_design.output}",
          "entity_id": "semspec.local.workflow.design.${trigger.payload.slug}"
        }
      },
      "on_success": "generate_spec"
    },
    {
      "name": "generate_spec",
      "condition": {
        "field": "${trigger.payload.auto}",
        "operator": "eq",
        "value": true
      },
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.workflow",
        "role": "spec-writer",
        "model": "${trigger.payload.model}",
        "prompt": "Generate a technical specification based on the design for: ${trigger.payload.title}",
        "payload": {
          "workflow_slug": "${trigger.payload.slug}",
          "workflow_step": "spec",
          "title": "${trigger.payload.title}",
          "previous_entities": [
            "semspec.local.workflow.proposal.${trigger.payload.slug}",
            "semspec.local.workflow.design.${trigger.payload.slug}"
          ],
          "auto_continue": "${trigger.payload.auto}",
          "user_id": "${trigger.payload.user_id}",
          "channel_type": "${trigger.payload.channel_type}",
          "channel_id": "${trigger.payload.channel_id}"
        }
      },
      "on_success": "validate_spec",
      "on_fail": "notify_design_complete",
      "timeout": "5m"
    },
    {
      "name": "notify_design_complete",
      "action": {
        "type": "publish",
        "subject": "user.response.${trigger.payload.channel_type}.${trigger.payload.channel_id}",
        "payload": {
          "type": "result",
          "content": "Design generated successfully for **${trigger.payload.title}**.\n\nRun `/spec ${trigger.payload.slug}` to continue to the specification phase."
        }
      },
      "on_success": "complete"
    },
    {
      "name": "validate_spec",
      "action": {
        "type": "call",
        "subject": "workflow.validate.spec",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "document": "spec",
          "content": "${steps.generate_spec.output.content}"
        }
      },
      "on_success": "publish_spec_to_graph",
      "on_fail": "spec_failed",
      "timeout": "30s"
    },
    {
      "name": "publish_spec_to_graph",
      "condition": {
        "field": "${steps.validate_spec.output.valid}",
        "operator": "eq",
        "value": true
      },
      "action": {
        "type": "publish",
        "subject": "graph.ingest.entity",
        "payload": {
          "id": "semspec.local.workflow.spec.${trigger.payload.slug}",
          "triples": [
            {"predicate": "semspec.spec.title", "object": "${trigger.payload.title}"},
            {"predicate": "semspec.spec.content", "object": "${steps.generate_spec.output.content}"},
            {"predicate": "semspec.spec.status", "object": "specified"},
            {"predicate": "prov.was_derived_from", "object": "semspec.local.workflow.design.${trigger.payload.slug}"},
            {"predicate": "dc.terms.created", "object": "${execution.started_at}"}
          ]
        }
      },
      "on_success": "export_spec_to_file",
      "on_fail": "spec_failed"
    },
    {
      "name": "export_spec_to_file",
      "action": {
        "type": "publish",
        "subject": "output.workflow.documents",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "document": "spec",
          "content": "${steps.generate_spec.output}",
          "entity_id": "semspec.local.workflow.spec.${trigger.payload.slug}"
        }
      },
      "on_success": "generate_tasks"
    },
    {
      "name": "generate_tasks",
      "condition": {
        "field": "${trigger.payload.auto}",
        "operator": "eq",
        "value": true
      },
      "action": {
        "type": "publish_agent",
        "subject": "agent.task.workflow",
        "role": "tasks-writer",
        "model": "${trigger.payload.model}",
        "prompt": "Generate implementation tasks based on the specification for: ${trigger.payload.title}",
        "payload": {
          "workflow_slug": "${trigger.payload.slug}",
          "workflow_step": "tasks",
          "title": "${trigger.payload.title}",
          "previous_entities": [
            "semspec.local.workflow.proposal.${trigger.payload.slug}",
            "semspec.local.workflow.design.${trigger.payload.slug}",
            "semspec.local.workflow.spec.${trigger.payload.slug}"
          ],
          "auto_continue": false,
          "user_id": "${trigger.payload.user_id}",
          "channel_type": "${trigger.payload.channel_type}",
          "channel_id": "${trigger.payload.channel_id}"
        }
      },
      "on_success": "validate_tasks",
      "on_fail": "notify_spec_complete",
      "timeout": "5m"
    },
    {
      "name": "notify_spec_complete",
      "action": {
        "type": "publish",
        "subject": "user.response.${trigger.payload.channel_type}.${trigger.payload.channel_id}",
        "payload": {
          "type": "result",
          "content": "Specification generated successfully for **${trigger.payload.title}**.\n\nRun `/tasks ${trigger.payload.slug}` to generate the task breakdown."
        }
      },
      "on_success": "complete"
    },
    {
      "name": "validate_tasks",
      "action": {
        "type": "call",
        "subject": "workflow.validate.tasks",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "document": "tasks",
          "content": "${steps.generate_tasks.output.content}"
        }
      },
      "on_success": "publish_tasks_to_graph",
      "on_fail": "tasks_failed",
      "timeout": "30s"
    },
    {
      "name": "publish_tasks_to_graph",
      "condition": {
        "field": "${steps.validate_tasks.output.valid}",
        "operator": "eq",
        "value": true
      },
      "action": {
        "type": "publish",
        "subject": "graph.ingest.entity",
        "payload": {
          "id": "semspec.local.workflow.tasks.${trigger.payload.slug}",
          "triples": [
            {"predicate": "semspec.tasks.title", "object": "${trigger.payload.title}"},
            {"predicate": "semspec.tasks.content", "object": "${steps.generate_tasks.output.content}"},
            {"predicate": "semspec.tasks.status", "object": "ready"},
            {"predicate": "prov.was_derived_from", "object": "semspec.local.workflow.spec.${trigger.payload.slug}"},
            {"predicate": "dc.terms.created", "object": "${execution.started_at}"}
          ]
        }
      },
      "on_success": "export_tasks_to_file",
      "on_fail": "tasks_failed"
    },
    {
      "name": "export_tasks_to_file",
      "action": {
        "type": "publish",
        "subject": "output.workflow.documents",
        "payload": {
          "slug": "${trigger.payload.slug}",
          "document": "tasks",
          "content": "${steps.generate_tasks.output}",
          "entity_id": "semspec.local.workflow.tasks.${trigger.payload.slug}"
        }
      },
      "on_success": "notify_workflow_complete"
    },
    {
      "name": "notify_workflow_complete",
      "action": {
        "type": "publish",
        "subject": "user.response.${trigger.payload.channel_type}.${trigger.payload.channel_id}",
        "payload": {
          "type": "result",
          "content": "Workflow complete for **${trigger.payload.title}**!\n\nAll documents generated in `.semspec/changes/${trigger.payload.slug}/`:\n- proposal.md\n- design.md\n- spec.md\n- tasks.md\n\nRun `/check ${trigger.payload.slug}` to validate against project constitution, then `/approve ${trigger.payload.slug}` when ready."
        }
      },
      "on_success": "complete"
    },
    {
      "name": "generation_failed",
      "action": {
        "type": "publish",
        "subject": "user.response.${trigger.payload.channel_type}.${trigger.payload.channel_id}",
        "payload": {
          "type": "error",
          "content": "Proposal generation failed after ${execution.iteration} attempts.\n\nError: ${steps.generate_proposal.error}\n\nPlease try again or adjust the description."
        }
      },
      "on_success": "complete"
    },
    {
      "name": "design_failed",
      "action": {
        "type": "publish",
        "subject": "user.response.${trigger.payload.channel_type}.${trigger.payload.channel_id}",
        "payload": {
          "type": "error",
          "content": "Design generation failed.\n\nError: ${steps.generate_design.error}\n\nPlease review the proposal and try again with `/design ${trigger.payload.slug}`."
        }
      },
      "on_success": "complete"
    },
    {
      "name": "spec_failed",
      "action": {
        "type": "publish",
        "subject": "user.response.${trigger.payload.channel_type}.${trigger.payload.channel_id}",
        "payload": {
          "type": "error",
          "content": "Specification generation failed.\n\nError: ${steps.generate_spec.error}\n\nPlease review the design and try again with `/spec ${trigger.payload.slug}`."
        }
      },
      "on_success": "complete"
    },
    {
      "name": "tasks_failed",
      "action": {
        "type": "publish",
        "subject": "user.response.${trigger.payload.channel_type}.${trigger.payload.channel_id}",
        "payload": {
          "type": "error",
          "content": "Task generation failed.\n\nError: ${steps.generate_tasks.error}\n\nPlease review the specification and try again with `/tasks ${trigger.payload.slug}`."
        }
      },
      "on_success": "complete"
    },
    {
      "name": "complete",
      "action": {
        "type": "publish",
        "subject": "workflow.events",
        "payload": {
          "event": "workflow_complete",
          "workflow_id": "document-generation",
          "execution_id": "${execution.id}",
          "slug": "${trigger.payload.slug}",
          "status": "${execution.state}"
        }
      }
    }
  ],
  "on_complete": [
    {
      "type": "publish",
      "subject": "workflow.events",
      "payload": {
        "event": "workflow_finished",
        "workflow_id": "document-generation",
        "execution_id": "${execution.id}",
        "slug": "${trigger.payload.slug}",
        "duration": "${execution.duration}"
      }
    }
  ],
  "timeout": "30m",
  "max_iterations": 3
}
